name: Notify Telegram chat
on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed
      - reopened
    branches:
      - main

jobs:
  telegram-notify:
    runs-on: ubuntu-latest
    
    steps:

        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤ –ü–†)
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤ –ü–†  
      - name: Get commits
        id: get-commits
        run: |
          commit_count=${{ github.event.pull_request.commits }}
          echo "Number of commits: $commit_count"
          
          echo "REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)" >> $GITHUB_ENV
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$(git log origin/${{ github.head_ref }} --not origin/${{ github.base_ref }} --oneline --pretty=format:"%B" | grep -v '^$' | tac | nl -w 1 -s ' ' | sed 's/^/*/; s/ /.* /')" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º—ë–Ω –≤–µ—Ç–æ–∫ + —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –Ω–∏—Ö
      - name: Get branches names
        id: get-branches-names
        run: |
          echo "BASE_BRANCH_NAME=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "BASE_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.head_ref }}" >> $GITHUB_OUTPUT


        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ü–† (opened, synchronize, closed, reopened)
      - name: Get PR type
        id: get-pr-type
        run: |
          echo "PR_TYPE=${{ github.event.action }}" >> $GITHUB_OUTPUT


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¢–µ–ª–µ–≥—Ä–∞–º–º-–æ–ø–æ–≤–µ—â–µ–Ω–∏–π
      - name: Get telegram notify config
        id: get-tg-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-tg-notify.json"
          echo -e "PR_OPENED_CONFIG=$(jq -r '.["pr-opened"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_SYNCHRONIZE_CONFIG=$(jq -r '.["pr-synchronize"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_CLOSED_MERGED_TRUE_CONFIG=$(jq -r '.["pr-closed-merged-true"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_CLOSED_MERGED_FALSE_CONFIG=$(jq -r '.["pr-closed-merged-false"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_REOPENED_CONFIG=$(jq -r '.["pr-reopened"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT


      - name: Get GitHub->Teleram logins config
        id: get-gh-tg-logins-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-gh-tg-logins.json"
          echo -e "ACTOR_TG_LOGIN=$(jq -r '.${{ github.actor }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_AUTHOR_TG_LOGIN=$(jq -r '.${{ github.event.pull_request.user.login }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          if [[ "${{ steps.get-pr-type.outputs.PR_TYPE }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo -e "MERGE_AUTHOR_TG_LOGIN=$(jq -r '.${{ github.event.pull_request.merged_by.login }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          fi

        # –ü–† –æ—Ç–∫—Ä—ã—Ç, –æ–ø–≤–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º  
      - name: PR opened TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'opened' && steps.get-tg-config.outputs.PR_OPENED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.ACTOR_TG_LOGIN }} *c–¥–µ–ª–∞–ª Pull Request!* üöÄ
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            üìå *–ö–æ–º–º–∏—Ç—ã:* 
            ${{ env.COMMITS }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 

        # –ü–† –æ–±–Ω–æ–≤–ª—ë–Ω, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR synchronized TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'synchronize' && steps.get-tg-config.outputs.PR_SYNCHRONIZE_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown 
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.ACTOR_TG_LOGIN }} *–¥–æ–±–∞–≤–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Pull Request!* üõ†Ô∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
             
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
             
            üìå *–ö–æ–º–º–∏—Ç—ã:*  
            ${{ env.COMMITS }}
              
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤–µ—Ç–∫–∏ –ü–† —Å–ª–∏—Ç—ã
      - name: Get commits if merged
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == true && steps.get-tg-config.outputs.PR_CLOSED_MERGED_TRUE_CONFIG == 'true'
        id: get-commits-if-merged
        run: |
          echo "COMMITS_IF_MERGED<<EOF" >> $GITHUB_ENV
          echo "$(git log ${{ github.event.pull_request.merge_commit_sha }} --not origin/${{ github.base_ref }}~1 --oneline --pretty=format:"%B" | grep -v '^$' | tac | head -n -1 | nl -w 1 -s ' ' | sed 's/^/*/; s/ /.* /')" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


        # –ü–† –∑–∞–∫—Ä—ã—Ç, –≤–µ—Ç–∫–∏ —Å–ª–∏—Ç—ã, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR merged TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == true && steps.get-tg-config.outputs.PR_CLOSED_MERGED_TRUE_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.MERGE_AUTHOR_TG_LOGIN }} *–≤–º–µ—Ä–∂–∏–ª Pull Request!* üéØ
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            üìå *–ö–æ–º–º–∏—Ç—ã:* 
            ${{ env.COMMITS_IF_MERGED }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


        # –ü–† –∑–∞–∫—Ä—ã—Ç, –≤–µ—Ç–∫–∏ –ù–ï —Å–ª–∏—Ç—ã, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR declined TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == false && steps.get-tg-config.outputs.PR_CLOSED_MERGED_FALSE_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.PR_AUTHOR_TG_LOGIN }}, *—Ç–≤–æ–π Pull Request –∑–∞–∫—Ä—ã—Ç –±–µ–∑ —Å–ª–∏—è–Ω–∏—è –≤–µ—Ç–æ–∫* üö´
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})

            üîí *–ó–∞–∫—Ä—ã–ª:* @${{ steps.get-gh-tg-logins-config.outputs.ACTOR_TG_LOGIN }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


        # –ü–† –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR reopened TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'reopened' && steps.get-tg-config.outputs.PR_REOPENED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.PR_AUTHOR_TG_LOGIN }}, *—Ç–≤–æ–π Pull Request —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç!* üïäÔ∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})

            üîì *–û—Ç–∫—Ä—ã–ª:* @${{ steps.get-gh-tg-logins-config.outputs.ACTOR_TG_LOGIN }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }})
        
