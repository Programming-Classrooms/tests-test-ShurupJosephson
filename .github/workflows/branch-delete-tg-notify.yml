name: Branch Deleted
on:
  delete:
    branches:
      - '*'

jobs:
  telegram-notify:
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch'
    steps:

        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–≥-–æ–ø–æ–≤–µ—â–µ–Ω–∏–π)
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Get repo name
        run: echo "REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)" >> $GITHUB_ENV


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤–µ—Ç–æ–∫ + —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –Ω–∏—Ö
      - name: Get branches names
        id: get-branches-names
        run: |
          BASE_BRANCH_NAME=$(basename "$GITHUB_REF")
          echo "BASE_BRANCH_NAME=$BASE_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "BASE_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/$BASE_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "DELETED_BRANCH_NAME=${{ github.event.ref }}" >> $GITHUB_OUTPUT


       # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¢–µ–ª–µ–≥—Ä–∞–º–º-–æ–ø–æ–≤–µ—â–µ–Ω–∏–π
      - name: Get telegram notify config
        id: get-tg-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-tg-notify.json"
          echo -e "BRANCH_DELETED_CONFIG=$(jq -r '.["branch-deleted"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT


       # –ü–æ–ª—É—á–µ–Ω–∏–µ –¢–µ–ª–µ–≥—Ä–∞–º–º –ª–æ–≥–∏–Ω–æ–≤ –∏–∑ .json —Ñ–∞–π–ª–∞
      - name: Get GitHub->Teleram logins config
        id: get-gh-tg-logins-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-gh-tg-logins.json"
          echo -e "ACTOR_TG_LOGIN=$(jq -r '.${{ github.actor }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT


        # –í–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: Branch deleted TG notify
        if: steps.get-tg-config.outputs.BRANCH_DELETED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.ACTOR_TG_LOGIN }} *—É–¥–∞–ª–∏–ª –≤–µ—Ç–∫—É!* üóëÔ∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üå± *–£–¥–∞–ª—ë–Ω–Ω–∞—è –≤–µ—Ç–∫–∞:* ${{ steps.get-branches-names.outputs.DELETED_BRANCH_NAME }}

            üå≥ *–ë–∞–∑–æ–≤–∞—è –≤–µ—Ç–∫–∞:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }})
