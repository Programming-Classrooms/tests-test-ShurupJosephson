on:
  pull_request_review:
    types: [submitted]

jobs:
  telegram-notify:
    runs-on: ubuntu-latest
    steps:

        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–≥-–æ–ø–æ–≤–µ—â–µ–Ω–∏–π)
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ä–µ–≤—å—é (approved, commented, changes_requested)
      - name: Check review status
        id: check-review-status
        run: echo "REVIEW_STATUS=${{ github.event.review.state }}" >> $GITHUB_OUTPUT


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Get repository name
        run: |
          echo "REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)" >> $GITHUB_ENV


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º—ë–Ω –≤–µ—Ç–æ–∫ + —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –Ω–∏—Ö
      - name: Get branches names
        id: get-branches-names
        run: |
          echo "BASE_BRANCH_NAME=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "BASE_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT


        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Ä–µ–≤—å—é (–≤ —Å–ª—É—á–∞–µ –ø—É—Å—Ç–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –ø–æ–ª–µ "–ö–æ–º–º–µ–Ω—Ç" –±—É–¥–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
      - name: Get review body
        id: get-review-body
        run: |
          if [[ -n "${{ github.event.review.body }}" ]]; then
            REVIEW_BODY=""
            REVIEW_BODY+="\n"
            REVIEW_BODY+="üí¨ *–ö–æ–º–º–µ–Ω—Ç:* ${{ github.event.review.body }}"
            REVIEW_BODY+="\n"

            echo "REVIEW_BODY<<EOF" >> $GITHUB_ENV
            echo -e $REVIEW_BODY >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "REVIEW_BODY=" >> $GITHUB_ENV
          fi

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ .json —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¢–µ–ª–µ–≥—Ä–∞–º–º-–æ–ø–æ–≤–µ—â–µ–Ω–∏–π
      - name: Get telegram notify config
        id: get-tg-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-tg-notify.json"
          echo -e "PR_REVIEW_APPROVED_CONFIG=$(jq -r '.["pr-review-approved"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_REVIEW_COMMENTED_CONFIG=$(jq -r '.["pr-review-commented"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_REVIEW_CHANGES_REQUESTED_CONFIG=$(jq -r '.["pr-review-changes-requested"]["is-active"]' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT


        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¢–µ–ª–µ–≥—Ä–∞–º–º –ª–æ–≥–∏–Ω–æ–≤ –∏–∑ .json —Ñ–∞–π–ª–∞
      - name: Get GitHub->Teleram logins config
        id: get-gh-tg-logins-config
        run: |
          CONFIG_FILE_PATH=".github/workflows/config-gh-tg-logins.json"
          echo -e "ACTOR_TG_LOGIN=$(jq -r '.${{ github.actor }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "REVIEWER_TG_LOGIN=$(jq -r '.${{ github.event.review.user.login }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          echo -e "PR_AUTHOR_TG_LOGIN=$(jq -r '.${{ github.event.pull_request.user.login }}' $CONFIG_FILE_PATH)" >> $GITHUB_OUTPUT
          

        # –ü–† –æ–¥–æ–±—Ä–µ–Ω, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR approved telegram notify
        if: steps.check-review-status.outputs.REVIEW_STATUS == 'approved' && steps.get-tg-config.outputs.PR_REVIEW_APPROVED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.PR_AUTHOR_TG_LOGIN }}, *—Ç–≤–æ–π Pull Request –æ–¥–æ–±—Ä–µ–Ω! –ú–æ–∂–µ—à—å —Å–ª–∏—Ç—å –≤–µ—Ç–∫–∏!* üéâ
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            ‚úÖ *–†–µ–≤—å—é–µ—Ä:*  @${{ steps.get-gh-tg-logins-config.outputs.REVIEWER_TG_LOGIN }}
            ${{ env.REVIEW_BODY }}
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


        # PR –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
        # (–ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ç.–∫. GitHub –Ω–µ –¥–∞—Å—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–∫–æ–µ —Ä–µ–≤—å—é —Å –ø—É—Å—Ç—ã–º –∫–æ–º–º–µ–Ω—Ç–æ–º)
      - name: PR commented telegram notify
        if: steps.check-review-status.outputs.REVIEW_STATUS == 'commented' && steps.get-tg-config.outputs.PR_REVIEW_COMMENTED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.PR_AUTHOR_TG_LOGIN }}, *—Ç–≤–æ–π Pull Request –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω!* üìù
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            ‚ùé *–†–µ–≤—å—é–µ—Ä:*  @${{ steps.get-gh-tg-logins-config.outputs.REVIEWER_TG_LOGIN }}
            ${{ env.REVIEW_BODY }}
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


        # –í –ü–† –∑–∞–ø—Ä–æ—à–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–º
      - name: PR changes requested telegram notify
        if: steps.check-review-status.outputs.REVIEW_STATUS == 'changes_requested' && steps.get-tg-config.outputs.PR_REVIEW_CHANGES_REQUESTED_CONFIG == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ steps.get-gh-tg-logins-config.outputs.PR_AUTHOR_TG_LOGIN }}, *–≤ —Ç–≤–æ—ë–º Pull Request —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è* ‚òùÔ∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            ‚ùé *–†–µ–≤—å—é–µ—Ä:*  @${{ steps.get-gh-tg-logins-config.outputs.REVIEWER_TG_LOGIN }}
            ${{ env.REVIEW_BODY }}
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 
